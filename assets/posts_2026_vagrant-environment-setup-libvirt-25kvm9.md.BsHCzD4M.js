import{_ as s,c as i,ah as n,o as t}from"./chunks/framework.BrGMoIXL.js";const c=JSON.parse('{"title":"Vagrant环境搭建(libvirt)","description":"","frontmatter":{"title":"Vagrant环境搭建(libvirt)","date":"2022-05-16 09:12:28","head":[],"outline":"deep","sidebar":false,"prev":false,"next":false},"headers":[],"relativePath":"posts/2026/vagrant-environment-setup-libvirt-25kvm9.md","filePath":"posts/2026/vagrant-environment-setup-libvirt-25kvm9.md"}'),e={name:"posts/2026/vagrant-environment-setup-libvirt-25kvm9.md"};function p(l,a,h,r,o,d){return t(),i("div",null,a[0]||(a[0]=[n(`<h1 id="vagrant环境搭建-libvirt" tabindex="-1">Vagrant环境搭建(libvirt) <a class="header-anchor" href="#vagrant环境搭建-libvirt" aria-label="Permalink to &quot;Vagrant环境搭建(libvirt)&quot;">​</a></h1><h2 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># pacman -S vagrant</span></span>
<span class="line"><span>$ vagrant plugin install vagrant-libvirt</span></span></code></pre></div><h2 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h2><h3 id="libvirt" tabindex="-1">Libvirt <a class="header-anchor" href="#libvirt" aria-label="Permalink to &quot;Libvirt&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># usermod -a -G libvirt &lt;user&gt;</span></span>
<span class="line"><span>$ export LIBVIRT_DEFAULT_URI=&quot;qemu:///system&quot;</span></span>
<span class="line"><span>$ let-env LIBVIRT_DEFAULT_URI = &quot;qemu:///system&quot;</span></span>
<span class="line"><span>$ virsh pool-define-as vagrant dir - - - - /usr/share/vagrant</span></span>
<span class="line"><span>$ virsh pool-build vagrant</span></span>
<span class="line"><span>$ virsh pool-start vagrant</span></span>
<span class="line"><span>$ virsh pool-autostart vagrant</span></span></code></pre></div><h4 id="network" tabindex="-1">Network <a class="header-anchor" href="#network" aria-label="Permalink to &quot;Network&quot;">​</a></h4><ul><li>网络配置文件</li></ul><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">network</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ipv6</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;yes&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;vagrant-virbr2&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">forward</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;nat&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">bridge</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;virbr2&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> stp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;on&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> delay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ip</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;192.168.121.1&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> netmask</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;255.255.255.0&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dhcp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">range</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> start</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;192.168.121.1&#39;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> end</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;192.168.121.254&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dhcp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">forwarder</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> addr</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;8.8.8.8&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">/&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dns</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">network</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><ul><li>使网络配置文件生效</li></ul><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ virsh net-define network.xml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ virsh net-start vagrant-virbr2</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ virsh net-autostart vagrant-virbr2</span></span></code></pre></div><h3 id="vagrant初始化" tabindex="-1">Vagrant初始化 <a class="header-anchor" href="#vagrant初始化" aria-label="Permalink to &quot;Vagrant初始化&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>vagrant init xxxx</span></span>
<span class="line"><span>vagrant up --provider=libvirt</span></span></code></pre></div><h3 id="vagrant配置" tabindex="-1">Vagrant配置 <a class="header-anchor" href="#vagrant配置" aria-label="Permalink to &quot;Vagrant配置&quot;">​</a></h3><h4 id="provider配置" tabindex="-1">provider配置 <a class="header-anchor" href="#provider配置" aria-label="Permalink to &quot;provider配置&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>config.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, type: &quot;nfs&quot;, nfs_udp: false, nfs_version: &quot;4.2&quot;</span></span>
<span class="line"><span>config.vm.provider :libvirt do |libvirt|</span></span>
<span class="line"><span>    # 存储池名称</span></span>
<span class="line"><span>    libvirt.storage_pool_name = &quot;vagrant&quot;</span></span>
<span class="line"><span>    # 使用系统接口</span></span>
<span class="line"><span>    libvirt.uri = &quot;qemu:///system&quot;</span></span>
<span class="line"><span>    # 默认网络修改</span></span>
<span class="line"><span>    libvirt.management_network_name = &quot;vagrant-virbr2&quot;</span></span>
<span class="line"><span>    # 阻止自定义网络被删除</span></span>
<span class="line"><span>    libvirt.management_network_keep = true</span></span>
<span class="line"><span>  end</span></span></code></pre></div><h2 id="问题记录" tabindex="-1">问题记录 <a class="header-anchor" href="#问题记录" aria-label="Permalink to &quot;问题记录&quot;">​</a></h2><h3 id="call-to-virdomaincreatewithflags-failed-unable-to-get-index-for-interface-eth0" tabindex="-1">Call to virDomainCreateWithFlags failed: Unable to get index for interface eth0 <a class="header-anchor" href="#call-to-virdomaincreatewithflags-failed-unable-to-get-index-for-interface-eth0" aria-label="Permalink to &quot;Call to virDomainCreateWithFlags failed: Unable to get index for interface eth0&quot;">​</a></h3><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">config.vm.network &quot;public_network&quot;, ip: &quot;192.168.1.89&quot;, bridge: &quot;virtbr0&quot;, dev: &quot;virtbr0&quot;, type: &quot;bridge&quot;</span></span></code></pre></div><p>‍</p><h3 id="kitty-terminfo" tabindex="-1">Kitty terminfo <a class="header-anchor" href="#kitty-terminfo" aria-label="Permalink to &quot;Kitty terminfo&quot;">​</a></h3><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">infocmp -a xterm-kitty | vagrant ssh -c &quot;tic -x -o \\~/.terminfo /dev/stdin&quot;</span></span></code></pre></div><p>‍</p><h3 id="透明代理没有网络" tabindex="-1">透明代理没有网络 <a class="header-anchor" href="#透明代理没有网络" aria-label="Permalink to &quot;透明代理没有网络&quot;">​</a></h3><h4 id="tcpdump" tabindex="-1">tcpdump <a class="header-anchor" href="#tcpdump" aria-label="Permalink to &quot;tcpdump&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># tcpdump -i any host 47.117.137.199 and port 80</span></span>
<span class="line"><span>13:46:46.560770 vnet0 P   IP 192.168.121.232.48700 &gt; 47.117.137.199.http: Flags [S], seq 2895886837, win 64240, options [mss 1460,sackOK,TS val 3837247923 ecr 0,nop,wscale 7], length 0</span></span>
<span class="line"><span>13:46:46.560770 virbr1 In  IP 192.168.121.232.48700 &gt; 47.117.137.199.http: Flags [S], seq 2895886837, win 64240, options [mss 1460,sackOK,TS val 3837247923 ecr 0,nop,wscale 7], length 0</span></span></code></pre></div><p>修改<code>prerouting</code>中的saddr，屏蔽掉网段</p><h4 id="修改dns" tabindex="-1">修改DNS <a class="header-anchor" href="#修改dns" aria-label="Permalink to &quot;修改DNS&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>virsh net-edit vagrant-libvirt</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;network ipv6=&#39;yes&#39;&gt;</span></span>
<span class="line"><span>  &lt;name&gt;vagrant-libvirt&lt;/name&gt;</span></span>
<span class="line"><span>  &lt;uuid&gt;90a8c64e-3da9-40bf-9df4-0e87580d1715&lt;/uuid&gt;</span></span>
<span class="line"><span>  &lt;forward mode=&#39;nat&#39;/&gt;</span></span>
<span class="line"><span>  &lt;bridge name=&#39;virbr1&#39; stp=&#39;on&#39; delay=&#39;0&#39;/&gt;</span></span>
<span class="line"><span>  &lt;mac address=&#39;52:54:00:6c:25:36&#39;/&gt;</span></span>
<span class="line"><span>  &lt;dns&gt;</span></span>
<span class="line"><span>    &lt;forwarder addr=&#39;8.8.8.8&#39;/&gt;</span></span>
<span class="line"><span>  &lt;/dns&gt;</span></span>
<span class="line"><span>  &lt;ip address=&#39;192.168.121.1&#39; netmask=&#39;255.255.255.0&#39;&gt;</span></span>
<span class="line"><span>    &lt;dhcp&gt;</span></span>
<span class="line"><span>      &lt;range start=&#39;192.168.121.1&#39; end=&#39;192.168.121.254&#39;/&gt;</span></span>
<span class="line"><span>    &lt;/dhcp&gt;</span></span>
<span class="line"><span>  &lt;/ip&gt;</span></span>
<span class="line"><span>&lt;/network&gt;</span></span></code></pre></div><p>添加dns段，指定上游dns，需要将libvirtd添加到nft白名单</p><h3 id="共享文件" tabindex="-1">共享文件 <a class="header-anchor" href="#共享文件" aria-label="Permalink to &quot;共享文件&quot;">​</a></h3><p><strong>NFS挂载卡死</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>config.vm.synced_folder &quot;./&quot;, &quot;/vagrant&quot;, type: &quot;nfs&quot;, nfs_udp: false, nfs_version: &quot;4.2&quot;</span></span></code></pre></div><p>调整nfs版本，4.2版本不支持<code>udp</code>​​协议，所以改为<code>false</code></p><p>同时需要开启libvirtd区域防火墙的nfs服务</p><p><strong>防火墙未开启</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>firewall-cmd --add-service=nfs --zone=libvirtd --permanent</span></span></code></pre></div><h3 id="自动在本地执行命令" tabindex="-1">自动在本地执行命令 <a class="header-anchor" href="#自动在本地执行命令" aria-label="Permalink to &quot;自动在本地执行命令&quot;">​</a></h3><p>通过trigger执行</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span></span></span></code></pre></div><ul><li>小心返回值和错误输出，会导致任务异常</li></ul><h3 id="手动下载box并载入" tabindex="-1">手动下载Box并载入 <a class="header-anchor" href="#手动下载box并载入" aria-label="Permalink to &quot;手动下载Box并载入&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>vagrant box add &lt;boxname&gt; /path/to/box</span></span>
<span class="line"><span>vagrant box add rockylinux/9 ~/Downloads/rockylinux9.box</span></span></code></pre></div><h3 id="_9p挂载" tabindex="-1">9p挂载 <a class="header-anchor" href="#_9p挂载" aria-label="Permalink to &quot;9p挂载&quot;">​</a></h3><h4 id="修改qemu默认为为root启动" tabindex="-1">修改qemu默认为为root启动 <a class="header-anchor" href="#修改qemu默认为为root启动" aria-label="Permalink to &quot;修改qemu默认为为root启动&quot;">​</a></h4><p>用以解决虚拟机挂载非qemu用户目录时，没有权限的问题</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sed -i -E &#39;s/^[#]?\\s?user\\s?=\\s?.*/user = &quot;root&quot;/&#39; /etc/libvirt/qemu.conf</span></span>
<span class="line"><span>sed -i -E &#39;s/^[#]?\\s?group\\s?=\\s?.*/group = &quot;root&quot;/&#39; /etc/libvirt/qemu.conf</span></span></code></pre></div><h4 id="加载9p驱动-首次9p驱动加载失败后" tabindex="-1">加载9p驱动(首次9p驱动加载失败后) <a class="header-anchor" href="#加载9p驱动-首次9p驱动加载失败后" aria-label="Permalink to &quot;加载9p驱动(首次9p驱动加载失败后)&quot;">​</a></h4><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span></code></pre></div>`,50)]))}const g=s(e,[["render",p]]);export{c as __pageData,g as default};
